"use strict";(self.webpackChunkcli_for_microsoft_365_docs=self.webpackChunkcli_for_microsoft_365_docs||[]).push([[72601],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>y});var r=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=r.createContext({}),u=function(e){var t=r.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(a),m=n,y=d["".concat(l,".").concat(m)]||d[m]||p[m]||o;return a?r.createElement(y,s(s({ref:t},c),{},{components:a})):r.createElement(y,s({ref:t},c))}));function y(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,s=new Array(o);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[d]="string"==typeof e?e:n,s[1]=i;for(var u=2;u<o;u++)s[u]=a[u];return r.createElement.apply(null,s)}return r.createElement.apply(null,a)}m.displayName="MDXCreateElement"},85162:(e,t,a)=>{a.d(t,{Z:()=>s});var r=a(67294),n=a(86010);const o={tabItem:"tabItem_Ymn6"};function s(e){let{children:t,hidden:a,className:s}=e;return r.createElement("div",{role:"tabpanel",className:(0,n.Z)(o.tabItem,s),hidden:a},t)}},74866:(e,t,a)=>{a.d(t,{Z:()=>v});var r=a(87462),n=a(67294),o=a(86010),s=a(12466),i=a(56697),l=a(91980),u=a(67392),c=a(50012);function d(e){return function(e){return n.Children.map(e,(e=>{if(!e||(0,n.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:a,attributes:r,default:n}}=e;return{value:t,label:a,attributes:r,default:n}}))}function p(e){const{values:t,children:a}=e;return(0,n.useMemo)((()=>{const e=t??d(a);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,a])}function m(e){let{value:t,tabValues:a}=e;return a.some((e=>e.value===t))}function y(e){let{queryString:t=!1,groupId:a}=e;const r=(0,i.k6)(),o=function(e){let{queryString:t=!1,groupId:a}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:t,groupId:a});return[(0,l._X)(o),(0,n.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(r.location.search);t.set(o,e),r.replace({...r.location,search:t.toString()})}),[o,r])]}function $(e){const{defaultValue:t,queryString:a=!1,groupId:r}=e,o=p(e),[s,i]=(0,n.useState)((()=>function(e){let{defaultValue:t,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=a.find((e=>e.default))??a[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:o}))),[l,u]=y({queryString:a,groupId:r}),[d,$]=function(e){let{groupId:t}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,o]=(0,c.Nk)(a);return[r,(0,n.useCallback)((e=>{a&&o.set(e)}),[a,o])]}({groupId:r}),f=(()=>{const e=l??d;return m({value:e,tabValues:o})?e:null})();(0,n.useLayoutEffect)((()=>{f&&i(f)}),[f]);return{selectedValue:s,selectValue:(0,n.useCallback)((e=>{if(!m({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);i(e),u(e),$(e)}),[u,$,o]),tabValues:o}}var f=a(72389);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function h(e){let{className:t,block:a,selectedValue:i,selectValue:l,tabValues:u}=e;const c=[],{blockElementScrollPositionUntilNextRender:d}=(0,s.o5)(),p=e=>{const t=e.currentTarget,a=c.indexOf(t),r=u[a].value;r!==i&&(d(t),l(r))},m=e=>{let t=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{const a=c.indexOf(e.currentTarget)+1;t=c[a]??c[0];break}case"ArrowLeft":{const a=c.indexOf(e.currentTarget)-1;t=c[a]??c[c.length-1];break}}t?.focus()};return n.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":a},t)},u.map((e=>{let{value:t,label:a,attributes:s}=e;return n.createElement("li",(0,r.Z)({role:"tab",tabIndex:i===t?0:-1,"aria-selected":i===t,key:t,ref:e=>c.push(e),onKeyDown:m,onClick:p},s,{className:(0,o.Z)("tabs__item",b.tabItem,s?.className,{"tabs__item--active":i===t})}),a??t)})))}function g(e){let{lazy:t,children:a,selectedValue:r}=e;const o=(Array.isArray(a)?a:[a]).filter(Boolean);if(t){const e=o.find((e=>e.props.value===r));return e?(0,n.cloneElement)(e,{className:"margin-top--md"}):null}return n.createElement("div",{className:"margin-top--md"},o.map(((e,t)=>(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==r}))))}function P(e){const t=$(e);return n.createElement("div",{className:(0,o.Z)("tabs-container",b.tabList)},n.createElement(h,(0,r.Z)({},e,t)),n.createElement(g,(0,r.Z)({},e,t)))}function v(e){const t=(0,f.Z)();return n.createElement(P,(0,r.Z)({key:String(t)},e))}},76528:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>y,frontMatter:()=>i,metadata:()=>u,toc:()=>d});var r=a(87462),n=(a(67294),a(3905)),o=a(74866),s=a(85162);const i={tags:["ai","azure","users"]},l="Analyze User Profile Photos using Azure Computer Vision API",u={unversionedId:"sample-scripts/aad/analyze-user-profile-photos/index",id:"sample-scripts/aad/analyze-user-profile-photos/index",title:"Analyze User Profile Photos using Azure Computer Vision API",description:"Author: Joseph Velliah",source:"@site/docs/sample-scripts/aad/analyze-user-profile-photos/index.mdx",sourceDirName:"sample-scripts/aad/analyze-user-profile-photos",slug:"/sample-scripts/aad/analyze-user-profile-photos/",permalink:"/cli-microsoft365-docusaurus/sample-scripts/aad/analyze-user-profile-photos/",draft:!1,editUrl:"https://github.com/pnp/cli-microsoft365/blob/main/docs/docs/sample-scripts/aad/analyze-user-profile-photos/index.mdx",tags:[{label:"ai",permalink:"/cli-microsoft365-docusaurus/tags/ai"},{label:"azure",permalink:"/cli-microsoft365-docusaurus/tags/azure"},{label:"users",permalink:"/cli-microsoft365-docusaurus/tags/users"}],version:"current",lastUpdatedAt:1683143859,formattedLastUpdatedAt:"May 3, 2023",frontMatter:{tags:["ai","azure","users"]},sidebar:"sampleScripts",previous:{title:"Introduction",permalink:"/cli-microsoft365-docusaurus/sample-scripts/introduction"},next:{title:"Analyze users for known data breaches with have i been pwned",permalink:"/cli-microsoft365-docusaurus/sample-scripts/aad/analyze-users-haveibeenpwnd/"}},c={},d=[],p={toc:d},m="wrapper";function y(e){let{components:t,...a}=e;return(0,n.kt)(m,(0,r.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"analyze-user-profile-photos-using-azure-computer-vision-api"},"Analyze User Profile Photos using Azure Computer Vision API"),(0,n.kt)("p",null,"Author: ",(0,n.kt)("a",{parentName:"p",href:"https://sprider.blog/analyze-microsoft-365-user-profile-photos-using-azure-computer-vision-api"},"Joseph Velliah")),(0,n.kt)("p",null,"This script uses Azure Cognitive Service API and Microsoft 365 CLI to analyze user profile pictures and assess whether they meet the standards placed by the organization. It can be customized to ban content within an org channel or collaboration network where employees post pictures, memes, etc."),(0,n.kt)("p",null,"Prerequisites"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://pnp.github.io/cli-microsoft365/"},"CLI for Microsoft 365")),(0,n.kt)("li",{parentName:"ul"},"Microsoft 365 users"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://azure.microsoft.com/services/cognitive-services/computer-vision/"},"Computer Vision API")," instance and API key")),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"If you don't already have an ",(0,n.kt)("a",{parentName:"p",href:"https://azure.microsoft.com/try/cognitive-services/"},"Azure Cognitive Services instance and key"),", create a cognitive service instance and get API key from there.")),(0,n.kt)(o.Z,{mdxType:"Tabs"},(0,n.kt)(s.Z,{value:"PowerShell",mdxType:"TabItem"},(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-powershell"},'$resultDir = "Output"\n$azureVisionApiInstance = "azure-vision-api-instance-name"\n$azureVisionApiKey = "azure-vision-api-key"\n\n$photoRequirements = @{\n    requirePortrait   = $false\n    allowClipart      = $true\n    allowLinedrawing  = $true\n    allowAdult        = $false\n    allowRacy         = $false\n    allowGory         = $false\n    photoRequirements = @{\n        requirePortrait   = $false\n        allowClipart      = $true\n        allowLinedrawing  = $true\n        allowAdult        = $false\n        allowRacy         = $false\n        allowGory         = $false\n        forbiddenKeywords = @("cartoon", `\n                "animal", `\n                "nude", `\n                "child", `\n                "people", `\n                "group", `\n                "family", `\n                "several", `\n                "crowd", `\n                "food", `\n                "restaurant", `\n                "train", `\n                "bus", `\n                "car", `\n                "airplane", `\n                "vehicle", `\n                "platform", `\n                "station", `\n                "standing", `\n                "flying", `\n                "suitcase", `\n                "screenshot", `\n                "newspaper", `\n                "typography", `\n                "font", `\n                "document", `\n                "sport")\n    }\n}\n\n$requiredProfileProperties = "id,displayName,userPrincipalName"\n$global:analysisOutcomes = @()\n\n$executionDir = $PSScriptRoot\n$outputDir = "$executionDir/$resultDir"\n$outputFilePath = "$outputDir/$(get-date -f yyyyMMdd-HHmmss)-scan-profile-pictures-outcome.csv"\n\nif (-not (Test-Path -Path "$outputDir" -PathType Container)) {\n    New-Item -ItemType Directory -Path "$outputDir"\n    Write-Host "Created $outputDir folder..."\n}\nfunction AddAnalysisOutcome {\n    param (\n        [Parameter(Mandatory = $false)] [string] $UserId,\n        [Parameter(Mandatory = $false)] [string] $UserPrincipalName,\n        [Parameter(Mandatory = $false)] [bool] $IsPortraitValid,\n        [Parameter(Mandatory = $false)] [bool] $IsOnlyOnePersonValid,\n        [Parameter(Mandatory = $false)] [bool] $IsClipartValid,\n        [Parameter(Mandatory = $false)] [bool] $IsLineDrawingValid,\n        [Parameter(Mandatory = $false)] [bool] $IsAdultValid,\n        [Parameter(Mandatory = $false)] [bool] $IsRacyValid,\n        [Parameter(Mandatory = $false)] [bool] $IsGoryValid,\n        [Parameter(Mandatory = $false)] [bool] $IsCelebrity,\n        [Parameter(Mandatory = $false)] [bool] $IsForbiddenKeywordExist,\n        [Parameter(Mandatory = $false)] [bool] $IsValidProfilePhoto,\n        [Parameter(Mandatory = $false)] [string] $Notes\n    )\n\n    $analysisOutcome = New-Object -TypeName PSObject\n\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "UserId" -Value $UserId\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "UserPrincipalName" -Value $UserPrincipalName\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsPortraitValid" -Value $IsPortraitValid\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsOnlyOnePersonValid" -Value $IsOnlyOnePersonValid\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsClipartValid" -Value $IsClipartValid\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsLineDrawingValid" -Value $IsLineDrawingValid\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsAdultValid" -Value $IsAdultValid\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsRacyValid" -Value $IsRacyValid\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsGoryValid" -Value $IsGoryValid\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsCelebrity" -Value $IsCelebrity\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsForbiddenKeywordExist" -Value $IsForbiddenKeywordExist\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "IsValidProfilePhoto" -Value $IsValidProfilePhoto\n    $analysisOutcome | Add-Member -MemberType NoteProperty -Name "Notes" -Value $Notes\n\n    $global:analysisOutcomes += $analysisOutcome\n}\n\n$users = m365 aad user list --properties $requiredProfileProperties -o json | ConvertFrom-Json -AsHashtable\n$usersCount = $users.Count\nWrite-Host "Number of users found : $usersCount"\n\ntry {\n    $token = m365 util accesstoken get --resource https://graph.microsoft.com\n\n    $i = 0\n\n    for ($i = 0; $i -lt $usersCount; $i++) {\n        try {\n            $userId = $users[$i].id\n            $userPrincipalName = $users[$i].userPrincipalName\n\n            $percentComplete = ($i / $usersCount) * 100\n            Write-Progress -Activity "Analysing" -Status "User : $userId - $userPrincipalName" -PercentComplete $percentComplete\n\n            try {\n                $headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"\n                $headers.Add("Content-Type", "image/jpg")\n                $headers.Add("Authorization", "Bearer $token")\n                $userPhoto = (Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/users/$userId/photo/`$value" -Headers $headers)\n\n                if ($userPhoto) {\n                    try {\n                        $headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"\n                        $headers.Add("Content-Type", "application/json")\n                        $headers.Add("Ocp-Apim-Subscription-Key", $azureVisionApiKey)\n\n                        $analysis = (Invoke-RestMethod -Uri ("https://$azureVisionApiInstance.cognitiveservices.azure.com/vision/v3.1/analyze?visualFeatures=Categories,Adult,Tags,Description,Faces,Color,ImageType,Objects&details=Celebrities&language=en") `\n                                -Headers $headers `\n                                -Body ($userPhoto) `\n                                -ContentType "application/octet-stream" `\n                                -Method "Post");\n\n                        if ($analysis) {\n                            $analysisData = $analysis | ConvertFrom-Json -AsHashtable\n                            $isPortrait = $analysisData.categories.Length -gt 0 ? ($analysisData.categories | Where-Object { $_.name -eq \'people_portrait\' }).Length -gt 0  ? $true : $false : $false\n                            $isPortraitValid = $photoRequirements.requirePortrait ? $isPortrait : $true\n                            $isOnlyOnePersonValid = $analysisData.faces.Length -eq 1 ? $true : $false\n                            $isClipartValid = $analysisData.imageType.clipArtType -eq 0 ? $true : $false\n                            $isLineDrawingValid = $analysisData.imageType.lineDrawingType -eq 0 ? $true : $false\n                            $isAdultValid = $photoRequirements.allowAdult ? $true : !$analysisData.adult.isAdultContent\n                            $isRacyValid = $photoRequirements.allowRacy ? $true : !$analysisData.adult.isRacyContent\n                            $isGoryValid = $photoRequirements.allowGory ? $true : !$analysisData.adult.isGoryContent\n                            $isCelebrity = ($analysisData.categories | Where-Object { $_.detail.celebrities.Length -gt 0 }).Length -gt 0 ? $true : $false\n\n                            $invalidKeywords = @()\n\n                            foreach ($forbiddenKeyword in $photoRequirements.forbiddenKeywords) {\n                                $isForbiddenKeywordExist = ($analysisData.tags | Where-Object { $_.name -eq $forbiddenKeyword }).Length -gt 0 ? $true : $false\n\n                                if ($isForbiddenKeywordExist) {\n                                    $invalidKeyword = New-Object -TypeName PSObject\n                                    $invalidKeyword | Add-Member -MemberType NoteProperty -Name forbiddenKeyword -Value $forbiddenKeyword\n                                    $invalidKeywords += $invalidKeyword\n                                }\n                            }\n\n                            $isForbiddenKeywordExist = $invalidKeywords.Length -gt 0 ? $true : $false\n\n                            $isValidProfilePhoto = $isPortraitValid `\n                                -and $isOnlyOnePersonValid `\n                                -and $isClipartValid  `\n                                -and $isLineDrawingValid `\n                                -and $isAdultValid `\n                                -and $isRacyValid `\n                                -and $isGoryValid `\n                                -and !$isCelebrity `\n                                -and !$isForbiddenKeywordExist;\n\n                            AddAnalysisOutcome $userId `\n                                $userPrincipalName `\n                                $isPortraitValid `\n                                $isOnlyOnePersonValid `\n                                $isClipartValid `\n                                $isLineDrawingValid `\n                                $isAdultValid `\n                                $isRacyValid `\n                                $isGoryValid `\n                                $isCelebrity `\n                                $isForbiddenKeywordExist `\n                                $isValidProfilePhoto `\n                                "Profile photo available"\n                        }\n                    }\n                    catch {\n                        AddAnalysisOutcome $userId `\n                            $userPrincipalName `\n                            $false `\n                            $false `\n                            $false `\n                            $false `\n                            $false `\n                            $false `\n                            $false `\n                            $false `\n                            $false `\n                            $false `\n                            "Unable to analyze profile photo"\n                    }\n                }\n            }\n            catch {\n                AddAnalysisOutcome $userId `\n                    $userPrincipalName `\n                    $false `\n                    $false `\n                    $false `\n                    $false `\n                    $false `\n                    $false `\n                    $false `\n                    $false `\n                    $false `\n                    $false `\n                    "Unable to get profile photo"\n            }\n        }\n        catch {\n            Write-Host "Unable to get profile details for this user" -ForegroundColor Red\n        }\n    }\n}\ncatch {\n    Write-Host "Unable to get new access token" -ForegroundColor Red\n}\n\n$global:analysisOutcomes | Export-Csv -Path "$outputFilePath" -NoTypeInformation\nWrite-Host "Open $outputFilePath to review analysis outcomes report."\n')))))}y.isMDXComponent=!0}}]);