"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[29991],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>f});var n=r(67294);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){s(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,n,s=function(e,t){if(null==e)return{};var r,n,s={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(s[r]=e[r]);return s}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}var a=n.createContext({}),c=function(e){var t=n.useContext(a),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},p=function(e){var t=c(e.components);return n.createElement(a.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,s=e.mdxType,i=e.originalType,a=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(r),d=s,f=u["".concat(a,".").concat(d)]||u[d]||m[d]||i;return r?n.createElement(f,l(l({ref:t},p),{},{components:r})):n.createElement(f,l({ref:t},p))}));function f(e,t){var r=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var i=r.length,l=new Array(i);l[0]=d;var o={};for(var a in t)hasOwnProperty.call(t,a)&&(o[a]=t[a]);o.originalType=e,o[u]="string"==typeof e?e:s,l[1]=o;for(var c=2;c<i;c++)l[c]=r[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},4021:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var n=r(87462),s=(r(67294),r(3905));const i={tags:["guests","security","users"]},l="List all external users in all site collections",o={unversionedId:"sample-scripts/spo/list-site-externalusers/index",id:"sample-scripts/spo/list-site-externalusers/index",title:"List all external users in all site collections",description:"Author: Albert-Jan Schot",source:"@site/docs/sample-scripts/spo/list-site-externalusers/index.md",sourceDirName:"sample-scripts/spo/list-site-externalusers",slug:"/sample-scripts/spo/list-site-externalusers/",permalink:"/sample-scripts/spo/list-site-externalusers/",draft:!1,editUrl:"https://github.com/pnp/cli-microsoft365/blob/main/docs/docs/sample-scripts/spo/list-site-externalusers/index.md",tags:[{label:"guests",permalink:"/tags/guests"},{label:"security",permalink:"/tags/security"},{label:"users",permalink:"/tags/users"}],version:"current",lastUpdatedBy:"Jwaegebaert",lastUpdatedAt:1672784370,formattedLastUpdatedAt:"Jan 3, 2023",frontMatter:{tags:["guests","security","users"]},sidebar:"sampleScripts",previous:{title:"List site collection owners",permalink:"/sample-scripts/spo/list-site-collection-owners/"},next:{title:"List all tenant-wide extensions",permalink:"/sample-scripts/spo/list-tenant-wide-extensions/"}},a={},c=[],p={toc:c};function u(e){let{components:t,...r}=e;return(0,s.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"list-all-external-users-in-all-site-collections"},"List all external users in all site collections"),(0,s.kt)("p",null,"Author: ",(0,s.kt)("a",{parentName:"p",href:"https://www.cloudappie.nl/migration-report-external-users/"},"Albert-Jan Schot")),(0,s.kt)("p",null,"This script helps you to list all external users in all SharePoint Online sites. It provides insights in who the users are, and if available who they where invited by."),(0,s.kt)("p",null,'=== "PowerShell"'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'```powershell\n$fileExportPath = "<PUTYOURPATHHERE.csv>"\n\n$m365Status = m365 status --output text\n\nif ($m365Status -eq "Logged Out") {\n  # Connection to Microsoft 365\n  m365 login\n}\n\n$results = @()\nWrite-host "Retrieving all sites and check external users..."\n$allSPOSites = m365 spo site list | ConvertFrom-Json\n$siteCount = $allSPOSites.Count\n\nWrite-Host "Processing $siteCount sites..."\n#Loop through each site\n$siteCounter = 0\n\nforeach ($site in $allSPOSites) {\n  $siteCounter++\n  Write-Host "Processing $($site.Url)... ($siteCounter/$siteCount)"\n\n  Write-host "Retrieving all external users ..."\n\n  $users = m365 spo user list --webUrl $site.Url --output json --query "[?contains(LoginName,\'#ext#\')]" | ConvertFrom-Json\n\n  foreach ($user in $users) {\n    $externalUserObject = m365 spo externaluser list --siteUrl $site.url -o json --query "[?AcceptedAs == \'$($user.Email)\']" | ConvertFrom-Json\n\n    $results += [pscustomobject][ordered]@{\n      UserPrincipalName = $user.UserPrincipalName\n      Email             = $user.Email\n      InvitedAs         = $externalUserObject.InvitedAs\n      WhenCreated       = $externalUserObject.WhenCreated\n      InvitedBy         = $externalUserObject.InvitedBy\n      Url               = $site.Url\n    }\n  }\n}\n\nWrite-Host "Exporting file to $fileExportPath..."\n$results | Export-Csv -Path $fileExportPath -NoTypeInformation\nWrite-Host "Completed."\n```\n')))}u.isMDXComponent=!0}}]);